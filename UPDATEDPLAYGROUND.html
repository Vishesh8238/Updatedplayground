<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mega Playground ‚Äî HTML/CSS/JS (500+ lines)</title>
  <!--
    Mega Playground
    -----------------
    A single-file web app that showcases many vanilla HTML/CSS/JS techniques:
      ‚Ä¢ Theme toggle (light/dark & accent colors)
      ‚Ä¢ Animated particle background (Canvas)
      ‚Ä¢ Dock-style navigation with keyboard shortcuts
      ‚Ä¢ Live clock and fuzzy greeting
      ‚Ä¢ To‚ÄëDo list with localStorage persistence
      ‚Ä¢ Sticky notes (autosave & color tags)
      ‚Ä¢ Pomodoro timer (focus/break cycles)
      ‚Ä¢ Calculator (keyboard enabled)
      ‚Ä¢ Drawing canvas (brush size/color, erase, save PNG)
      ‚Ä¢ Mini audio player (playlist + visual progress)
      ‚Ä¢ Image gallery with drag & drop upload and client-side thumbnails
      ‚Ä¢ Command palette (Ctrl/Cmd + K) to jump anywhere
      ‚Ä¢ Simple settings pane (density, rounded corners, motion)

    The file is intentionally verbose (>500 lines) with comments to help learning.
  -->
  <style>
    /* ---------------------------------------------------------
       CSS RESET & THEME TOKENS
       --------------------------------------------------------- */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    :root {
      --bg: #0b0e13;
      /* default dark */
      --panel: #121723;
      --elev: #171d2b;
      --text: #e6edf3;
      --muted: #96a2b4;
      --border: #263147;
      --accent: #8b7cf6;
      /* purple */
      --accent-2: #57d8ff;
      /* cyan */
      --ok: #36d399;
      --warn: #f7b731;
      --danger: #ff6b6b;
      --radius: 16px;
      --density: 1;
      /* 1 = default spacing multiplier */
      --shadow: 0 8px 30px rgba(0, 0, 0, .25);
      --motion: 1;
      /* 1 = animations on */
    }

    .light {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --elev: #f2f4f8;
      --text: #0c1222;
      --muted: #4b5566;
      --border: #d8dce6;
      --accent: #5c6cff;
      --accent-2: #00bcd4;
      --shadow: 0 10px 25px rgba(0, 0, 0, .08);
    }

    /* ---------------------------------------------------------
       GLOBAL LAYOUT
       --------------------------------------------------------- */
    body {
      background: radial-gradient(1200px 600px at 10% -10%, rgba(139, 124, 246, .15), transparent 60%),
        radial-gradient(800px 500px at 110% 10%, rgba(87, 216, 255, .12), transparent 60%),
        var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: saturate(1.2) blur(8px);
      background: color-mix(in srgb, var(--bg) 80%, transparent);
      border-bottom: 1px solid var(--border);
    }

    .topbar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      padding: calc(14px * var(--density)) clamp(12px, 3vw, 24px);
      max-width: 1200px;
      margin: 0 auto;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: .3px;
    }

    .brand .logo {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 50%, transparent), 0 6px 18px color-mix(in srgb, var(--accent) 35%, transparent);
    }

    .brand small {
      color: var(--muted);
      font-weight: 600;
      margin-left: 6px;
      opacity: .9;
    }

    .search {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .02);
    }

    .search input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
    }

    .kbd {
      padding: 2px 6px;
      border: 1px solid var(--border);
      border-bottom-width: 2px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-self: end;
      align-items: center;
    }

    .btn {
      cursor: pointer;
      border: none;
      background: var(--elev);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      transition: transform .15s ease, background .2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn.accent {
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 80%, transparent), color-mix(in srgb, var(--accent-2) 70%, transparent));
    }

    main {
      max-width: 1200px;
      margin: 18px auto 80px;
      padding: 0 clamp(12px, 3vw, 24px);
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 18px;
    }

    .card {
      grid-column: span 12;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card>header {
      position: unset;
      backdrop-filter: none;
      background: none;
      border-bottom: 1px dashed var(--border);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
    }

    .card-title {
      font-weight: 700;
      letter-spacing: .3px;
    }

    .card-sub {
      color: var(--muted);
      font-size: 13px;
    }

    .card-body {
      padding: 14px 16px;
    }

    /* Responsive column spans */
    @media (min-width: 700px) {
      .span-6 {
        grid-column: span 6;
      }

      .span-4 {
        grid-column: span 4;
      }

      .span-8 {
        grid-column: span 8;
      }
    }

    /* ---------------------------------------------------------
       UTILITIES
       --------------------------------------------------------- */
    .muted {
      color: var(--muted);
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .col {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .fill {
      flex: 1;
    }

    .chip {
      font-size: 12px;
      padding: 6px 8px;
      border: 1px solid var(--border);
      background: var(--elev);
      border-radius: 999px;
    }

    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border), transparent);
      margin: 10px 0;
    }

    .sr-only {
      position: absolute;
      left: -9999px;
    }

    /* ---------------------------------------------------------
       PARTICLE BACKGROUND (beneath content)
       --------------------------------------------------------- */
    #bgCanvas {
      position: fixed;
      inset: 0;
      z-index: -1;
    }

    /* ---------------------------------------------------------
       SECTIONS SPECIFIC STYLES
       --------------------------------------------------------- */
    /* Hero */
    .hero {
      display: grid;
      gap: 8px;
      align-items: center;
      grid-template-columns: 1fr auto;
    }

    .hero-title {
      font-size: clamp(22px, 3vw, 32px);
      font-weight: 800;
      letter-spacing: .3px;
    }

    .hero-sub {
      color: var(--muted);
    }

    /* To-Do */
    .todo-input {
      display: flex;
      gap: 8px;
    }

    .todo-input input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--elev);
      color: var(--text);
    }

    .todo-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    .todo-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: linear-gradient(180deg, var(--elev), transparent);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .todo-item.done {
      opacity: .7;
      text-decoration: line-through;
    }

    .todo-item button {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    /* Notes */
    .notes-wrap {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .note {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: conic-gradient(from 180deg at 50% 0%, color-mix(in srgb, var(--accent) 12%, transparent), var(--panel));
      box-shadow: inset 0 -40px 60px rgba(0, 0, 0, .05);
    }

    .note textarea {
      resize: vertical;
      min-height: 120px;
      padding: 8px;
      border-radius: 10px;
      border: 1px dashed var(--border);
      background: var(--elev);
      color: var(--text);
    }

    /* Pomodoro */
    .pomodoro {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      align-items: center;
    }

    .pom-time {
      font-size: 42px;
      font-weight: 800;
      text-align: center;
    }

    .pom-ctrl {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    /* Calculator */
    .calc {
      width: 100%;
      max-width: 340px;
      margin-inline: auto;
    }

    .calc-screen {
      font-size: 28px;
      padding: 10px;
      border: 1px solid var(--border);
      background: var(--elev);
      border-radius: 12px;
      text-align: right;
      min-height: 42px;
    }

    .calc-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .calc-grid button {
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      cursor: pointer;
      font-weight: 600;
    }

    /* Draw */
    .draw-toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .draw-toolbar input[type="color"] {
      padding: 0;
      height: 36px;
      width: 48px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--elev);
    }

    .draw-canvas {
      width: 100%;
      height: 320px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: repeating-conic-gradient(from 0deg, rgba(255, 255, 255, .02) 0 5deg, transparent 5deg 10deg), var(--panel);
    }

    /* Gallery */
    .dropzone {
      display: grid;
      place-items: center;
      padding: 20px;
      border: 2px dashed var(--border);
      border-radius: 12px;
      background: var(--elev);
    }

    .thumbs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .thumb {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--panel);
    }

    .thumb img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    .thumb .name {
      padding: 6px 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .thumb .del {
      position: absolute;
      right: 8px;
      top: 8px;
      border: none;
      background: rgba(0, 0, 0, .35);
      color: #fff;
      border-radius: 999px;
      width: 26px;
      height: 26px;
      cursor: pointer;
    }

    /* Audio */
    .audio {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .audio progress {
      width: 100%;
      height: 8px;
    }

    .audio button {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--elev);
      color: var(--text);
      cursor: pointer;
    }

    /* Command Palette */
    dialog[open] {
      animation: var(--motion, 1) paletteIn .15s ease;
    }

    @keyframes paletteIn {
      from {
        transform: translateY(-12px);
        opacity: .6
      }

      to {
        transform: none;
        opacity: 1
      }
    }

    .palette {
      max-width: 640px;
      width: 95vw;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--panel);
      padding: 0;
      box-shadow: var(--shadow);
    }

    .palette .p-head {
      padding: 14px;
      border-bottom: 1px dashed var(--border);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .palette .p-head input {
      flex: 1;
      background: var(--elev);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
    }

    .palette .p-list {
      max-height: 300px;
      overflow: auto;
    }

    .palette .p-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px dashed var(--border);
      cursor: pointer;
    }

    .palette .p-item:hover {
      background: color-mix(in srgb, var(--accent) 16%, transparent);
    }

    /* Footer */
    footer {
      padding: 20px;
      text-align: center;
      color: var(--muted);
      border-top: 1px dashed var(--border);
      background: color-mix(in srgb, var(--bg) 80%, transparent);
    }

    /* Accessibility focus rings */
    :focus-visible {
      outline: 2px solid color-mix(in srgb, var(--accent) 60%, white 40%);
      outline-offset: 2px;
    }
  </style>
</head>

<body class="light">
  <!-- Background Canvas for Particles -->
  <canvas id="bgCanvas" aria-hidden="true"></canvas>

  <!-- Top bar -->
  <header>
    <div class="topbar">
      <div class="brand" aria-label="App Brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          Mega Playground <small class="muted">HTML/CSS/JS</small>
        </div>
      </div>

      <div class="search" role="search">
        <input id="globalSearch" type="search" placeholder="Search (Ctrl/Cmd + K) e.g. 'timer' or 'draw'"
          aria-label="Global Search" />
        <span class="kbd" aria-hidden="true">‚åò/Ctrl + K</span>
      </div>

      <div class="actions">
        <button id="themeBtn" class="btn" title="Toggle theme" aria-pressed="false">üåó Theme</button>
        <button id="accentBtn" class="btn" title="Shuffle accent">üé® Accent</button>
        <button id="helpBtn" class="btn">‚ùì Help</button>
        <span id="clock" class="chip" aria-live="polite">--:--</span>
      </div>
    </div>
  </header>

  <main>
    <!-- Hero / Greeting -->
    <section class="card">
      <div class="card-header">
        <div class="hero">
          <div>
            <div class="hero-title">Welcome, <span id="hiName">friend</span> üëã</div>
            <div class="hero-sub">This sandbox packs a bunch of mini‚Äëapps. Explore with the dock below or hit <span
                class="kbd">Ctrl/Cmd + K</span> to jump anywhere. Everything is saved locally.</div>
          </div>
          <div class="row">
            <span class="chip" id="greet">Have a great day!</span>
            <span class="chip">Tip: drag images into the gallery</span>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="grid">
          <!-- To‚ÄëDo List -->
          <article id="todo" class="card span-6">
            <header class="card-header">
              <div>
                <div class="card-title">‚úÖ To‚ÄëDo</div>
                <div class="card-sub">Quick tasks with filters and persistence</div>
              </div>
              <div class="row">
                <button class="btn" id="todoFilterAll">All</button>
                <button class="btn" id="todoFilterActive">Active</button>
                <button class="btn" id="todoFilterDone">Done</button>
              </div>
            </header>
            <div class="card-body">
              <div class="todo-input">
                <input id="todoText" placeholder="e.g., Finish math assignment" />
                <button id="addTodo" class="btn accent">Add</button>
              </div>
              <div class="divider"></div>
              <div id="todoList" class="todo-list" aria-live="polite"></div>
            </div>
          </article>

          <!-- Notes -->
          <article id="notes" class="card span-6">
            <header class="card-header">
              <div>
                <div class="card-title">üìù Notes</div>
                <div class="card-sub">Sticky notes with autosave and colors</div>
              </div>
              <button id="newNote" class="btn accent">New Note</button>
            </header>
            <div class="card-body">
              <div class="notes-wrap" id="notesWrap"></div>
            </div>
          </article>

          <!-- Pomodoro Timer -->
          <article id="pomodoro" class="card span-4">
            <header class="card-header">
              <div class="card-title">‚è±Ô∏è Pomodoro</div>
              <div class="card-sub">25:00 focus + 5:00 break cycles</div>
            </header>
            <div class="card-body">
              <div class="pomodoro">
                <div class="pom-time" id="pomTime">25:00</div>
                <div class="col">
                  <label>Focus (min)
                    <input id="focusLen" type="number" min="1" value="25" />
                  </label>
                  <label>Break (min)
                    <input id="breakLen" type="number" min="1" value="5" />
                  </label>
                </div>
                <div class="pom-ctrl">
                  <button id="pomStart" class="btn accent">Start</button>
                  <button id="pomPause" class="btn">Pause</button>
                  <button id="pomReset" class="btn">Reset</button>
                </div>
              </div>
            </div>
          </article>

          <!-- Calculator -->
          <article id="calc" class="card span-4">
            <header class="card-header">
              <div class="card-title">üßÆ Calculator</div>
              <div class="card-sub">Mouse & keyboard friendly</div>
            </header>
            <div class="card-body">
              <div class="calc">
                <div id="calcScreen" class="calc-screen" aria-live="polite">0</div>
                <div class="calc-grid" id="calcGrid"></div>
              </div>
            </div>
          </article>

          <!-- Drawing -->
          <article id="draw" class="card span-4">
            <header class="card-header">
              <div class="card-title">üé® Drawing Canvas</div>
              <div class="card-sub">Brush, erase, clear, save PNG</div>
            </header>
            <div class="card-body">
              <div class="draw-toolbar">
                <label>Brush <input id="brush" type="range" min="1" max="40" value="6" /></label>
                <input id="color" type="color" value="#5c6cff" />
                <button id="modeDraw" class="btn accent">Draw</button>
                <button id="modeErase" class="btn">Erase</button>
                <button id="clearCanvas" class="btn">Clear</button>
                <button id="savePNG" class="btn">Save PNG</button>
              </div>
              <canvas id="drawCanvas" class="draw-canvas"></canvas>
            </div>
          </article>

          <!-- Gallery -->
          <article id="gallery" class="card span-8">
            <header class="card-header">
              <div>
                <div class="card-title">üñºÔ∏è Gallery</div>
                <div class="card-sub">Drag & drop images, stored locally</div>
              </div>
              <div class="row">
                <input id="filePick" type="file" accept="image/*" multiple />
                <button id="clearGallery" class="btn">Clear</button>
              </div>
            </header>
            <div class="card-body">
              <div id="dropzone" class="dropzone">Drop images here or use the file picker</div>
              <div id="thumbs" class="thumbs"></div>
            </div>
          </article>

          <!-- Audio player -->
          <article id="audio" class="card span-4">
            <header class="card-header">
              <div class="card-title">üîä Audio Player</div>
              <div class="card-sub">Load local tracks to play</div>
            </header>
            <div class="card-body">
              <div class="col">
                <input id="audioPick" type="file" accept="audio/*" multiple />
                <div class="audio">
                  <button id="audioPrev">‚èÆ</button>
                  <button id="audioPlay">‚ñ∂Ô∏è</button>
                  <button id="audioNext">‚è≠</button>
                  <progress id="audioProg" max="1" value="0"></progress>
                  <span id="audioTime" class="muted">0:00 / 0:00</span>
                </div>
                <div id="audioList" class="col"></div>
              </div>
            </div>
          </article>

          <!-- Settings -->
          <article id="settings" class="card span-12">
            <header class="card-header">
              <div class="card-title">‚öôÔ∏è Settings</div>
              <div class="card-sub">Tweak density, radius, and motion</div>
            </header>
            <div class="card-body">
              <div class="row">
                <label>Density <input id="density" type="range" min="0.8" max="1.4" step="0.05" value="1" /></label>
                <label>Radius <input id="radius" type="range" min="8" max="28" value="16" /></label>
                <label>Motion
                  <select id="motion">
                    <option value="1">On</option>
                    <option value="0">Reduce</option>
                  </select>
                </label>
                <button id="resetAll" class="btn">Reset All</button>
              </div>
            </div>
          </article>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Built for learning ‚Äî no libraries, just HTML/CSS/JS. Everything saves in your browser.
  </footer>

  <!-- Command Palette Modal -->
  <dialog id="palette" class="palette">
    <div class="p-head">
      <span>üîé</span>
      <input id="paletteInput" type="text" placeholder="Type a command or section name‚Ä¶" />
      <button id="paletteClose" class="btn">Close</button>
    </div>
    <div id="paletteList" class="p-list"></div>
  </dialog>

  <script>
    /* =========================================================
       UTILITIES & STORAGE HELPERS
       ========================================================= */
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const store = {
      get(key, def) { try { return JSON.parse(localStorage.getItem(key)) ?? def } catch { return def } },
      set(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
    };

    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
    const fmt = (n) => String(n).padStart(2, '0');

    /* =========================================================
       THEME, CLOCK, GREETINGS
       ========================================================= */
    const themeBtn = $('#themeBtn');
    const accentBtn = $('#accentBtn');
    const clockEl = $('#clock');
    const greetEl = $('#greet');

    const accentChoices = [
      ['#8b7cf6', '#57d8ff'],
      ['#ff6b6b', '#ffd166'],
      ['#00b894', '#00d2ff'],
      ['#5c6cff', '#00bcd4'],
      ['#ff8fab', '#a29bfe']
    ];

    function applyTheme(theme) {
      document.body.classList.toggle('light', theme === 'light');
      store.set('theme', theme);
    }

    function shuffleAccent() {
      const [a, b] = accentChoices[Math.floor(Math.random() * accentChoices.length)];
      document.documentElement.style.setProperty('--accent', a);
      document.documentElement.style.setProperty('--accent-2', b);
      store.set('accent', [a, b]);
    }

    function tickClock() {
      const now = new Date();
      clockEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const h = now.getHours();
      let g = 'Have a great day!';
      if (h < 5) g = 'Burning the midnight oil? ‚ú®';
      else if (h < 12) g = 'Good morning ‚òÄÔ∏è';
      else if (h < 18) g = 'Good afternoon üå§Ô∏è';
      else g = 'Good evening üåô';
      greetEl.textContent = g;
    }

    themeBtn.addEventListener('click', () => {
      const next = document.body.classList.contains('light') ? 'dark' : 'light';
      applyTheme(next);
    });
    accentBtn.addEventListener('click', shuffleAccent);
    setInterval(tickClock, 1000); tickClock();

    // Restore theme & accent
    const savedTheme = store.get('theme', 'light');
    applyTheme(savedTheme);
    const savedAccent = store.get('accent');
    if (savedAccent) {
      document.documentElement.style.setProperty('--accent', savedAccent[0]);
      document.documentElement.style.setProperty('--accent-2', savedAccent[1]);
    }

    /* =========================================================
       PARTICLE BACKGROUND (Canvas)
       ========================================================= */
    const bg = $('#bgCanvas');
    const bctx = bg.getContext('2d');
    let particles = [];

    function resizeBG() {
      bg.width = innerWidth * devicePixelRatio; bg.height = innerHeight * devicePixelRatio; bg.style.width = '100%'; bg.style.height = '100%';
    }
    addEventListener('resize', resizeBG); resizeBG();

    function initParticles() {
      const count = Math.floor((innerWidth * innerHeight) / 18000);
      particles = Array.from({ length: count }, () => ({
        x: Math.random() * bg.width,
        y: Math.random() * bg.height,
        vx: (Math.random() - .5) * .4 * devicePixelRatio,
        vy: (Math.random() - .5) * .4 * devicePixelRatio,
        r: Math.random() * 2 + 0.5
      }));
    }
    initParticles();

    function stepParticles() {
      bctx.clearRect(0, 0, bg.width, bg.height);
      const ac1 = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
      const ac2 = getComputedStyle(document.documentElement).getPropertyValue('--accent-2').trim();
      particles.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if (p.x < 0 || p.x > bg.width) p.vx *= -1;
        if (p.y < 0 || p.y > bg.height) p.vy *= -1;
        const g = bctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r * 4);
        g.addColorStop(0, ac1 + 'aa');
        g.addColorStop(1, 'transparent');
        bctx.fillStyle = g;
        bctx.beginPath(); bctx.arc(p.x, p.y, p.r * 6, 0, Math.PI * 2); bctx.fill();
      });
      requestAnimationFrame(stepParticles);
    }
    stepParticles();

    /* =========================================================
       COMMAND PALETTE & GLOBAL SEARCH
       ========================================================= */
    const palette = $('#palette');
    const paletteInput = $('#paletteInput');
    const paletteList = $('#paletteList');
    const openPalette = () => { palette.showModal(); paletteInput.value = ''; renderPalette(''); paletteInput.focus(); };
    const closePalette = () => palette.close();
    $('#paletteClose').addEventListener('click', closePalette);

    const commands = [
      { id: 'todo', label: 'Go to: To‚ÄëDo', action: () => $('#todo').scrollIntoView({ behavior: 'smooth' }) },
      { id: 'notes', label: 'Go to: Notes', action: () => $('#notes').scrollIntoView({ behavior: 'smooth' }) },
      { id: 'pomodoro', label: 'Go to: Pomodoro', action: () => $('#pomodoro').scrollIntoView({ behavior: 'smooth' }) },
      { id: 'calc', label: 'Go to: Calculator', action: () => $('#calc').scrollIntoView({ behavior: 'smooth' }) },
      { id: 'draw', label: 'Go to: Drawing', action: () => $('#draw').scrollIntoView({ behavior: 'smooth' }) },
      { id: 'gallery', label: 'Go to: Gallery', action: () => $('#gallery').scrollIntoView({ behavior: 'smooth' }) },
      { id: 'audio', label: 'Go to: Audio', action: () => $('#audio').scrollIntoView({ behavior: 'smooth' }) },
      { id: 'settings', label: 'Go to: Settings', action: () => $('#settings').scrollIntoView({ behavior: 'smooth' }) },
      { id: 'theme', label: 'Toggle theme', action: () => themeBtn.click() },
      { id: 'accent', label: 'Shuffle accent', action: () => accentBtn.click() },
      { id: 'clear-all', label: 'Reset: Clear local data', action: resetAll }
    ];

    function renderPalette(q) {
      const frag = document.createDocumentFragment();
      commands.filter(c => c.label.toLowerCase().includes(q.toLowerCase())).forEach(c => {
        const div = document.createElement('div');
        div.className = 'p-item';
        div.innerHTML = `<span>${c.label}</span><span class="kbd">‚Ü©</span>`;
        div.addEventListener('click', () => { c.action(); closePalette(); });
        frag.appendChild(div);
      });
      paletteList.innerHTML = ''; paletteList.appendChild(frag);
    }

    paletteInput.addEventListener('input', e => renderPalette(e.target.value));

    // Keyboard shortcuts
    addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); openPalette(); }
      if (e.key === 'Escape' && palette.open) closePalette();
    });
    $('#globalSearch').addEventListener('focus', openPalette);

    /* =========================================================
       TO‚ÄëDO LIST
       ========================================================= */
    const todoText = $('#todoText');
    const addTodo = $('#addTodo');
    const todoList = $('#todoList');
    let filter = store.get('todo:filter', 'all');

    function loadTodos() { return store.get('todo:items', []); }
    function saveTodos(items) { store.set('todo:items', items); }

    function renderTodos() {
      const items = loadTodos();
      todoList.innerHTML = '';
      const frag = document.createDocumentFragment();
      items
        .filter(i => filter === 'all' || (filter === 'active' && !i.done) || (filter === 'done' && i.done))
        .forEach((item, idx) => frag.appendChild(todoRow(item, idx)));
      todoList.appendChild(frag);
    }

    function todoRow(item, idx) {
      const row = document.createElement('div');
      row.className = 'todo-item' + (item.done ? ' done' : '');
      row.innerHTML = `
        <input type="checkbox" ${item.done ? 'checked' : ''} aria-label="Toggle done" />
        <div contenteditable="true" class="todo-text">${item.text}</div>
        <div>
          <button title="Delete">üóë</button>
        </div>`;
      const [ck, txt, del] = [row.children[0], row.children[1], row.children[2].children[0]];
      ck.addEventListener('change', () => { const items = loadTodos(); items[idx].done = ck.checked; saveTodos(items); renderTodos(); });
      txt.addEventListener('input', () => { const items = loadTodos(); items[idx].text = txt.textContent.trim(); saveTodos(items); });
      del.addEventListener('click', () => { const items = loadTodos(); items.splice(idx, 1); saveTodos(items); renderTodos(); });
      return row;
    }

    addTodo.addEventListener('click', () => {
      const text = todoText.value.trim();
      if (!text) return;
      const items = loadTodos();
      items.unshift({ text, done: false, ts: Date.now() });
      saveTodos(items); todoText.value = ''; renderTodos();
    });

    $('#todoFilterAll').addEventListener('click', () => { filter = 'all'; store.set('todo:filter', filter); renderTodos(); });
    $('#todoFilterActive').addEventListener('click', () => { filter = 'active'; store.set('todo:filter', filter); renderTodos(); });
    $('#todoFilterDone').addEventListener('click', () => { filter = 'done'; store.set('todo:filter', filter); renderTodos(); });

    renderTodos();

    /* =========================================================
       NOTES (sticky, autosave)
       ========================================================= */
    const notesWrap = $('#notesWrap');
    const newNoteBtn = $('#newNote');

    function loadNotes() { return store.get('notes:items', []); }
    function saveNotes(v) { store.set('notes:items', v); }

    function noteCard(n, idx) {
      const card = document.createElement('div');
      card.className = 'note';
      card.style.setProperty('--note-color', n.color || '');
      card.innerHTML = `
        <div class="row">
          <input type="color" value="${n.color}" title="Note color" />
          <input class="fill" value="${n.title}" placeholder="Title" />
          <button title="Delete" class="btn">üóë</button>
        </div>
        <textarea placeholder="Write something‚Ä¶">${n.text}</textarea>
      `;
      const [color, title, del] = [card.querySelector('input[type=color]'), card.querySelector('input.fill'), card.querySelector('button')];
      const ta = card.querySelector('textarea');
      const commit = () => { const arr = loadNotes(); arr[idx] = { ...arr[idx], title: title.value, text: ta.value, color: color.value }; saveNotes(arr); };
      color.addEventListener('input', commit);
      title.addEventListener('input', commit);
      ta.addEventListener('input', commit);
      del.addEventListener('click', () => { const arr = loadNotes(); arr.splice(idx, 1); saveNotes(arr); renderNotes(); });
      return card;
    }

    function renderNotes() {
      const arr = loadNotes();
      notesWrap.innerHTML = '';
      const frag = document.createDocumentFragment();
      arr.forEach((n, idx) => frag.appendChild(noteCard(n, idx)));
      notesWrap.appendChild(frag);
    }

    newNoteBtn.addEventListener('click', () => {
      const arr = loadNotes();
      arr.unshift({ title: 'Untitled', text: '', color: '#ffd166', ts: Date.now() });
      saveNotes(arr); renderNotes();
    });

    renderNotes();

    /* =========================================================
       POMODORO TIMER
       ========================================================= */
    const pomTime = $('#pomTime');
    const focusLen = $('#focusLen');
    const breakLen = $('#breakLen');
    const pomStart = $('#pomStart');
    const pomPause = $('#pomPause');
    const pomReset = $('#pomReset');

    let pom = { mode: 'focus', remain: 25 * 60, running: false, t: null };

    function updatePomDisplay() {
      pomTime.textContent = `${fmt(Math.floor(pom.remain / 60))}:${fmt(pom.remain % 60)}`;
    }

    function tickPom() {
      if (!pom.running) return;
      pom.remain--; updatePomDisplay();
      if (pom.remain <= 0) {
        const next = pom.mode === 'focus' ? 'break' : 'focus';
        pom.mode = next;
        const len = next === 'focus' ? Number(focusLen.value) : Number(breakLen.value);
        pom.remain = clamp(len, 1, 180) * 60;
        new Notification('Pomodoro', { body: next === 'focus' ? 'Time to focus!' : 'Take a break ‚òï' }).catch(() => { });
      }
      pom.t = setTimeout(tickPom, 1000);
    }

    pomStart.addEventListener('click', () => {
      pom.running = true;
      if (!('Notification' in window)) { } else if (Notification.permission === 'default') Notification.requestPermission();
      clearTimeout(pom.t); pom.t = setTimeout(tickPom, 1000);
    });
    pomPause.addEventListener('click', () => { pom.running = false; clearTimeout(pom.t); });
    pomReset.addEventListener('click', () => { pom.running = false; clearTimeout(pom.t); pom.mode = 'focus'; pom.remain = clamp(Number(focusLen.value), 1, 180) * 60; updatePomDisplay(); });

    // Initialize remaining time from inputs
    pom.remain = clamp(Number(focusLen.value), 1, 180) * 60; updatePomDisplay();

    /* =========================================================
       CALCULATOR
       ========================================================= */
    const calcGrid = $('#calcGrid');
    const calcScreen = $('#calcScreen');

    const keys = [
      'C', '‚Üê', '%', '/', '7', '8', '9', '*', '4', '5', '6', '-', '1', '2', '3', '+', '0', '.', '=', '('
    ];
    // Add close paren to reach 20 keys per row *some rows dynamic
    keys.push(')');

    function press(k) {
      const s = calcScreen.textContent === '0' ? '' : calcScreen.textContent;
      if (k === 'C') calcScreen.textContent = '0';
      else if (k === '‚Üê') calcScreen.textContent = s.slice(0, -1) || '0';
      else if (k === '=') {
        try { calcScreen.textContent = String(Function(`return (${s || '0'})`)()); } catch { calcScreen.textContent = 'Error'; }
      } else {
        calcScreen.textContent = (s + k).replace(/\b(\d+)\(%\)/, '($1/100)');
      }
    }

    keys.forEach(k => {
      const b = document.createElement('button');
      b.textContent = k; b.addEventListener('click', () => press(k)); calcGrid.appendChild(b);
    });

    addEventListener('keydown', e => {
      const ok = '0123456789+-*/().%';
      if (ok.includes(e.key)) press(e.key);
      else if (e.key === 'Enter') press('=');
      else if (e.key === 'Backspace') press('‚Üê');
    });

    /* =========================================================
       DRAWING CANVAS
       ========================================================= */
    const drawCanvas = $('#drawCanvas');
    const dctx = drawCanvas.getContext('2d');
    const brush = $('#brush');
    const color = $('#color');
    const modeDraw = $('#modeDraw');
    const modeErase = $('#modeErase');
    const clearCanvasBtn = $('#clearCanvas');
    const savePNGBtn = $('#savePNG');

    let drawing = false; let erase = false; let last = null;

    function resizeDraw() {
      const rect = drawCanvas.getBoundingClientRect();
      const temp = document.createElement('canvas');
      temp.width = drawCanvas.width; temp.height = drawCanvas.height;
      temp.getContext('2d').drawImage(drawCanvas, 0, 0);
      drawCanvas.width = rect.width * devicePixelRatio; drawCanvas.height = rect.height * devicePixelRatio;
      dctx.scale(devicePixelRatio, devicePixelRatio);
      dctx.drawImage(temp, 0, 0, rect.width, rect.height);
      dctx.lineCap = 'round'; dctx.lineJoin = 'round';
    }
    addEventListener('resize', resizeDraw);
    setTimeout(resizeDraw, 10);

    function drawLine(a, b) {
      if (erase) {
        dctx.globalCompositeOperation = 'destination-out';
        dctx.lineWidth = Number(brush.value);
      } else {
        dctx.globalCompositeOperation = 'source-over';
        dctx.strokeStyle = color.value;
        dctx.lineWidth = Number(brush.value);
      }

      dctx.beginPath();
      dctx.moveTo(a.x, a.y);
      dctx.lineTo(b.x, b.y);
      dctx.stroke();
    }

    function pos(e) {
      const r = drawCanvas.getBoundingClientRect();
      const x = (e.touches?.[0]?.clientX ?? e.clientX) - r.left;
      const y = (e.touches?.[0]?.clientY ?? e.clientY) - r.top;
      return { x, y };
    }

    function begin(e) { drawing = true; last = pos(e); }
    function move(e) { if (!drawing) return; const p = pos(e); drawLine(last, p); last = p; }
    function end() { drawing = false; last = null; }

    drawCanvas.addEventListener('mousedown', begin);
    drawCanvas.addEventListener('mousemove', move);
    addEventListener('mouseup', end);
    drawCanvas.addEventListener('touchstart', begin); drawCanvas.addEventListener('touchmove', move); addEventListener('touchend', end);

    modeDraw.addEventListener('click', () => { erase = false; modeDraw.classList.add('accent'); modeErase.classList.remove('accent'); });
    modeErase.addEventListener('click', () => { erase = true; modeErase.classList.add('accent'); modeDraw.classList.remove('accent'); });

    clearCanvasBtn.addEventListener('click', () => { dctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height); });
    savePNGBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'drawing.png';
      link.href = drawCanvas.toDataURL('image/png');
      link.click();
    });

    /* =========================================================
       GALLERY (Drag & Drop + localStorage)
       ========================================================= */
    const dropzone = $('#dropzone');
    const filePick = $('#filePick');
    const thumbs = $('#thumbs');

    function loadGallery() { return store.get('gallery:items', []); }
    function saveGallery(v) { store.set('gallery:items', v); }

    function renderGallery() {
      const items = loadGallery();
      thumbs.innerHTML = '';
      const frag = document.createDocumentFragment();
      items.forEach((it, idx) => frag.appendChild(thumb(it, idx)));
      thumbs.appendChild(frag);
    }

    function thumb(it, idx) {
      const t = document.createElement('div'); t.className = 'thumb';
      t.innerHTML = `<img src="${it.data}" alt="${it.name}"/><div class="name">${it.name}</div><button class="del" title="Delete">‚úï</button>`;
      t.querySelector('.del').addEventListener('click', () => { const arr = loadGallery(); arr.splice(idx, 1); saveGallery(arr); renderGallery(); });
      return t;
    }

    function filesToGallery(files) {
      [...files].forEach(f => {
        if (!f.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = () => { const arr = loadGallery(); arr.unshift({ name: f.name, data: reader.result, ts: Date.now() }); saveGallery(arr); renderGallery(); };
        reader.readAsDataURL(f);
      });
    }

    filePick.addEventListener('change', e => filesToGallery(e.target.files));

    ;['dragenter', 'dragover'].forEach(ev => dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.style.borderColor = 'var(--accent)'; }));
    ;['dragleave', 'drop'].forEach(ev => dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.style.borderColor = 'var(--border)'; }));
    dropzone.addEventListener('drop', e => { filesToGallery(e.dataTransfer.files); });

    $('#clearGallery').addEventListener('click', () => { saveGallery([]); renderGallery(); });

    renderGallery();

    /* =========================================================
       AUDIO PLAYER
       ========================================================= */
    const audioPick = $('#audioPick');
    const audioList = $('#audioList');
    const audioProg = $('#audioProg');
    const audioTime = $('#audioTime');
    const btnPrev = $('#audioPrev');
    const btnPlay = $('#audioPlay');
    const btnNext = $('#audioNext');
    const au = new Audio();
    let playlist = []; let idx = 0; let playing = false;

    function secondsToMMSS(s) { const m = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${m}:${String(sec).padStart(2, '0')}`; }

    function renderPlaylist() {
      audioList.innerHTML = '';
      playlist.forEach((p, i) => {
        const row = document.createElement('button');
        row.className = 'btn'; row.textContent = (i === idx ? '‚ñ∂ ' : '') + p.name;
        row.addEventListener('click', () => { idx = i; loadTrack(); play(); });
        audioList.appendChild(row);
      });
    }

    function loadTrack() { if (!playlist[idx]) return; au.src = playlist[idx].url; renderPlaylist(); }
    function play() { if (!playlist.length) return; au.play(); playing = true; btnPlay.textContent = '‚è∏'; }
    function pause() { au.pause(); playing = false; btnPlay.textContent = '‚ñ∂Ô∏è'; }

    audioPick.addEventListener('change', e => {
      playlist = [...e.target.files].map(f => ({ name: f.name, url: URL.createObjectURL(f) }));
      idx = 0; loadTrack();
    });

    btnPrev.addEventListener('click', () => { if (!playlist.length) return; idx = (idx - 1 + playlist.length) % playlist.length; loadTrack(); play(); });
    btnNext.addEventListener('click', () => { if (!playlist.length) return; idx = (idx + 1) % playlist.length; loadTrack(); play(); });
    btnPlay.addEventListener('click', () => { playing ? pause() : play(); });

    au.addEventListener('timeupdate', () => {
      const p = au.currentTime / (au.duration || 1); audioProg.value = p;
      audioTime.textContent = `${secondsToMMSS(au.currentTime)} / ${isFinite(au.duration) ? secondsToMMSS(au.duration) : '0:00'}`;
    });
    au.addEventListener('ended', () => btnNext.click());

    /* =========================================================
       SETTINGS (density, radius, motion) + RESET ALL
       ========================================================= */
    const density = $('#density');
    const radius = $('#radius');
    const motion = $('#motion');
    const resetAllBtn = $('#resetAll');

    function applySettings() {
      document.documentElement.style.setProperty('--density', density.value);
      document.documentElement.style.setProperty('--radius', radius.value + 'px');
      document.documentElement.style.setProperty('--motion', motion.value);
      store.set('settings', { density: density.value, radius: radius.value, motion: motion.value });
    }

    ;[density, radius, motion].forEach(el => el.addEventListener('input', applySettings));

    function loadSettings() {
      const s = store.get('settings', { density: 1, radius: 16, motion: 1 });
      density.value = s.density; radius.value = s.radius; motion.value = s.motion; applySettings();
    }
    loadSettings();

    function resetAll() {
      if (!confirm('Reset all data (todos, notes, gallery, player, settings)?')) return;
      localStorage.clear(); location.reload();
    }
    resetAllBtn.addEventListener('click', resetAll);

    /* =========================================================
       HELP BUTTON
       ========================================================= */
    $('#helpBtn').addEventListener('click', () => {
      alert(`Shortcuts & Tips\n\n‚Ä¢ Ctrl/Cmd + K opens the Command Palette\n‚Ä¢ Theme & accent controls in the header\n‚Ä¢ To‚ÄëDo/Notes/Gallery/Audio persist in localStorage\n‚Ä¢ Drag images into Gallery, or load audio files\n‚Ä¢ Drawing: change brush size/color, save PNG\n‚Ä¢ Settings: density (spacing), radius (rounded corners), motion (animations)`);
    });

    /* Set a fun default name if none has been used before */
    const hiName = $('#hiName');
    const storedName = store.get('profile:name', null);
    if (!storedName) {
      const guess = ['Ace', 'Coder', 'Captain', 'Vishesh', 'Legend', 'Pal'];
      const pick = guess[Math.floor(Math.random() * guess.length)];
      store.set('profile:name', pick);
      hiName.textContent = pick;
    } else {
      hiName.textContent = storedName;
    }
  </script>
</body>

</html>